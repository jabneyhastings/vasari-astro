---
import CmsImage from '../components/CmsImage.astro';

interface Slide {
  image: string;
  alt: string;
}

interface Props {
  slides: Slide[];
  autoAdvanceDelay?: number;
}

const { slides, autoAdvanceDelay = 5000 } = Astro.props;
---

<section class="carousel header__spacer" aria-label="Hero carousel" transition:name="hero">
  <div class="carousel__slides">
    {slides.map((slide, index) => (
      <div 
        class={`carousel__slide ${index === 0 ? 'carousel__slide--active' : ''}`}
        aria-hidden={index !== 0}
      >
        <div class="carousel__image-container">
          <CmsImage 
            src={slide.image}
            alt={slide.alt}
            width={2400}
            height={1350}
            loading={index === 0 ? 'eager' : 'lazy'}
            class="carousel__image"
            sizes="100vw"
          />
        </div>
      </div>
    ))}
  </div>
  
  {slides.length > 1 && (
    <div class="carousel__controls">
      <div class="carousel__dots" role="tablist" aria-label="Carousel navigation">
        {slides.map((slide, index) => (
          <button 
            class={`carousel__dot ${index === 0 ? 'carousel__dot--active' : ''}`}
            role="tab"
            aria-selected={index === 0}
            aria-label={`Go to slide ${index + 1}: ${slide.alt}`}
            data-slide={index}
          />
        ))}
      </div>
    </div>
  )}
</section>

<script define:vars={{ autoAdvanceDelay }}>
(function () {
    // Map<HTMLElement, HeroCarousel>
    const instances = new Map();

    class HeroCarousel {
        constructor(root) {
            this.root = root;
            this.slides = Array.from(root.querySelectorAll('.carousel__slide'));
            this.dots = Array.from(root.querySelectorAll('.carousel__dot'));
            this.currentSlide = 0;
            this.autoAdvanceTimer = null;

            // bound handlers so we can remove them later
            this.onRootClick = this.onRootClick.bind(this);
            this.onRootKeydown = this.onRootKeydown.bind(this);
            this.onTouchStart = this.onTouchStart.bind(this);
            this.onTouchEnd = this.onTouchEnd.bind(this);
            this.onFocusIn = this.onFocusIn.bind(this);
            this.onFocusOut = this.onFocusOut.bind(this);

            this.startX = 0;
            this.startY = 0;

            if (this.slides.length <= 1) return;

            this.init();
        }

        init() {
            instances.set(this.root, this);

            // Event delegation: single handlers attached to the root
            this.root.addEventListener('click', this.onRootClick);
            this.root.addEventListener('keydown', this.onRootKeydown);
            this.root.addEventListener('touchstart', this.onTouchStart, { passive: true });
            this.root.addEventListener('touchend', this.onTouchEnd, { passive: true });
            this.root.addEventListener('focusin', this.onFocusIn);
            this.root.addEventListener('focusout', this.onFocusOut);

            // ensure proper starting ARIA state
            this.slides.forEach((s, i) => {
                s.setAttribute('aria-hidden', i === 0 ? 'false' : 'true');
            });
            this.dots.forEach((d, i) => {
                d.setAttribute('aria-selected', i === 0 ? 'true' : 'false');
            });

            this.startAutoAdvance();
        }

        onRootClick(e) {
            // dot click
            const dot = e.target.closest('.carousel__dot');
            if (dot && this.root.contains(dot)) {
                const index = Number(dot.getAttribute('data-slide'));
                if (!Number.isNaN(index)) this.goToSlide(index);
                return;
            }

            // let normal link clicks inside slides behave naturally;
            // if links inside slides are not working, the problem is likely z-index/pointer-events.
        }

        onRootKeydown(e) {
            const dot = e.target.closest('.carousel__dot');
            if (!dot) return;
            const index = Number(dot.getAttribute('data-slide'));
            if (e.key === 'ArrowLeft' && index > 0) {
                this.goToSlide(index - 1);
                this.dots[index - 1].focus();
            } else if (e.key === 'ArrowRight' && index < this.dots.length - 1) {
                this.goToSlide(index + 1);
                this.dots[index + 1].focus();
            }
        }

        onTouchStart(e) {
            this.startX = e.touches[0].clientX;
            this.startY = e.touches[0].clientY;
        }

        onTouchEnd(e) {
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const diffX = this.startX - endX;
            const diffY = this.startY - endY;

            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                diffX > 0 ? this.nextSlide() : this.prevSlide();
            }
        }

        onFocusIn() {
            this.pauseAutoAdvance();
        }

        onFocusOut() {
            this.resumeAutoAdvance();
        }

        goToSlide(index) {
            if (index === this.currentSlide) return;

            const prevSlide = this.slides[this.currentSlide];
            const prevDot = this.dots[this.currentSlide];

            prevSlide?.classList.remove('carousel__slide--active');
            prevSlide?.setAttribute('aria-hidden', 'true');
            prevDot?.classList.remove('carousel__dot--active');
            prevDot?.setAttribute('aria-selected', 'false');

            this.currentSlide = index;

            const curSlide = this.slides[this.currentSlide];
            const curDot = this.dots[this.currentSlide];

            curSlide?.classList.add('carousel__slide--active');
            curSlide?.setAttribute('aria-hidden', 'false');
            curDot?.classList.add('carousel__dot--active');
            curDot?.setAttribute('aria-selected', 'true');

            this.resetAutoAdvance();
        }

        nextSlide() {
            const nextIndex = (this.currentSlide + 1) % this.slides.length;
            this.goToSlide(nextIndex);
        }

        prevSlide() {
            const prevIndex = this.currentSlide === 0 ? this.slides.length - 1 : this.currentSlide - 1;
            this.goToSlide(prevIndex);
        }

        startAutoAdvance() {
            this.clearTimers();
            this.autoAdvanceTimer = setTimeout(() => {
                this.nextSlide();
                this.startAutoAdvance();
            }, autoAdvanceDelay);
        }

        pauseAutoAdvance() {
            this.clearTimers();
        }

        resumeAutoAdvance() {
            this.startAutoAdvance();
        }

        resetAutoAdvance() {
            this.startAutoAdvance();
        }

        clearTimers() {
            clearTimeout(this.autoAdvanceTimer);
            this.autoAdvanceTimer = null;
        }

        destroy() {
            this.clearTimers();
            this.root.removeEventListener('click', this.onRootClick);
            this.root.removeEventListener('keydown', this.onRootKeydown);
            this.root.removeEventListener('touchstart', this.onTouchStart, { passive: true });
            this.root.removeEventListener('touchend', this.onTouchEnd, { passive: true });
            this.root.removeEventListener('focusin', this.onFocusIn);
            this.root.removeEventListener('focusout', this.onFocusOut);

            instances.delete(this.root);
        }
    }

    // Initialize any carousels in the document that don't already have instances
    function initCarousel() {
        document.querySelectorAll('.carousel').forEach((el) => {
            if (!instances.has(el)) {
                new HeroCarousel(el);
            }
        });
    }

    // Destroy all active instances (called before a view transition swap)
    function destroyAllInstances() {
        // iterate over a copy of the values to avoid mutation while iterating
        Array.from(instances.values()).forEach((inst) => {
            inst.destroy();
        });
    }

    // initial load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCarousel);
    } else {
        initCarousel();
    }

    // Clean up before Astro swaps the DOM
    document.addEventListener('astro:before-swap', () => {
        destroyAllInstances();
    });

    // Re-init after Astro has swapped the DOM
    document.addEventListener('astro:after-swap', () => {
        // small delay so DOM is stable; adjust if you need it immediate
        setTimeout(initCarousel, 30);
    });
})();
</script>

<style>
  .carousel {
    position: relative;
    height: 100svh;
    overflow: hidden;
  }

  .carousel__slides {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .carousel__slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .carousel__slide--active {
    opacity: 1;
  }

  .carousel__image-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  :global(.carousel__image) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
  }

  .carousel__controls {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
  }

  .carousel__dots {
    display: flex;
    gap: 2rem;
    align-items: center;
  }

  .carousel__dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    border: none;
    cursor: pointer;
    transition: background 0.3s ease;
    position: relative;
  }

  .carousel__dot--active {
    background: white;
  }

  .carousel__dot::after {
    content: "";
    position: absolute;
    inset: -12px;
    border: 1px solid white;
    border-radius: 50%;
    transform: scale(0.8);
    opacity: 0;
    transition: transform 0.5s ease, opacity 0.5s ease;
  }

  .carousel__dot--active::after {
    transform: scale(1);
    opacity: 1;
  }

  .carousel__dot:hover {
    background: rgba(255, 255, 255, 0.8);
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .carousel__slide {
      transition-duration: 0.3s;
    }
  }
</style>